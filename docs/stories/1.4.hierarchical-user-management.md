# Story 1.4: Hierarchical User Management

## Status
InProgress

## Story
**As a** Company Admin or Manager,
**I want** to invite and manage users with specific roles (Manager, Operator),
**so that** I can build and manage my team with appropriate access levels within my tenant organization.

## Acceptance Criteria
1. Company Admin can access a user management interface in the Filament admin panel
2. Company Admin can invite new users with Manager or Operator roles via email
3. Manager can invite new users with Operator role only (role hierarchy enforced)
4. User invitation emails are sent with secure signup links and proper tenant context
5. Company Admin can view a list of all users in their tenant organization
6. Company Admin can edit user details (name, email, role) for existing users
7. Company Admin can deactivate/reactivate user accounts
8. Company Admin can resend invitation emails for pending invitations
9. System enforces role-based permissions for user management actions
10. All user management activities are logged for audit purposes
11. User management interface is intuitive and supports bulk operations where appropriate
12. System prevents creating duplicate invitations for the same email within a tenant

## Tasks / Subtasks
- [x] Enhance Filament Admin Interface for User Management (AC: 1, 5, 6, 7, 11)
  - [x] Create User Management Resource in Filament
  - [x] Build user listing with role-based filtering and search
  - [x] Add user creation/editing forms with role selection
  - [x] Implement user deactivation/reactivation functionality
  - [x] Add bulk operations support for common actions
- [x] Implement Role-Based User Invitation System (AC: 2, 3, 4, 8, 9, 12)
  - [x] Enhance existing invitation system to support role hierarchy
  - [x] Add role validation to prevent Managers from inviting Admins
  - [x] Implement duplicate invitation prevention logic
  - [x] Add invitation resend functionality
  - [x] Update invitation email templates for different roles
- [x] Create User Management API Endpoints (AC: 2, 5, 6, 7, 9)
  - [x] Build REST endpoints for user CRUD operations
  - [x] Implement role-based authorization middleware
  - [x] Add tenant scoping to all user management endpoints
  - [x] Create invitation management endpoints
- [x] Enhance Activity Logging for User Management (AC: 10)
  - [x] Log user creation, modification, and deactivation events
  - [x] Log invitation sending and resending activities
  - [x] Log role changes and permission modifications
  - [x] Implement comprehensive audit trail for compliance
- [ ] Testing for User Management Features (AC: All)
  - [ ] Unit tests for User Management Resource and forms
  - [ ] Feature tests for invitation workflows with role hierarchy
  - [ ] Integration tests for API endpoints with proper authorization
  - [ ] Test role-based access control and permission enforcement
- [x] Project Cleanup (Infrastructure Maintenance)
  - [x] Remove deprecated apps/mobile/ directory
  - [x] Update any references to old mobile directory in documentation
  - [x] Verify mobile-app/ directory is properly configured and documented

## Dev Notes

### Previous Story Insights
From Story 1.2 (Super Admin Tenant Creation):
- Invitation system foundation exists with secure token generation and email templates
- TenantCreationService has acceptInvitation method for processing invitations
- Filament admin interface framework is already configured and working
- Activity logging is implemented using Laravel ActivityLog package
- Multi-tenancy isolation is working properly with stancl/tenancy package

From Story 1.3 (User Registration & Login):
- User model enhanced with role-based token abilities and tenant-aware authentication
- Authentication endpoints fully implemented with Laravel Sanctum
- Mobile authentication system working and tested
- Comprehensive test coverage patterns established

**Critical Note**: Story 1.2 QA review identified security vulnerabilities that may affect this story:
- Weak token generation in invitation system needs improvement
- Missing input validation for email formats
- No rate limiting on invitation endpoints
- Missing foreign key constraints and unique constraints

### Data Models
Core entities for this story: [Source: architecture/22-data-models.md]
- **User:** Individual users with roles (admin, manager, operator) and lifecycle fields (last_login_at, deleted_at, must_change_password)
- **Company (Tenant):** Root entity already established with proper tenant isolation
- **Invitation:** Existing model with secure token generation and validation methods (needs security enhancements)

### Backend Architecture Requirements
Service Architecture: [Source: architecture/44-backend-architecture-laravel.md]
- Serverless environment compatibility (AWS Lambda via Laravel Vapor)
- Repository Pattern for data access layer abstraction
- Laravel Sanctum for API authentication with tenant scoping
- Global stancl/tenancy middleware for request scoping

### Functional Requirements Alignment
This story directly implements: [Source: docs/prd.md]
- **FR2:** A "Company Admin" shall be able to invite and manage users with "Admin," "Manager," and "Operator" roles

### File Locations
Based on monorepo architecture: [Source: architecture/51-unified-project-structure-monorepo.md]
```
apps/api/app/Filament/Resources/UserResource.php      # Filament user management interface
apps/api/app/Http/Controllers/UserManagementController.php  # API endpoints for user management
apps/api/app/Http/Requests/InviteUserRequest.php      # User invitation validation
apps/api/app/Http/Requests/UpdateUserRequest.php      # User update validation
apps/api/app/Policies/UserPolicy.php                  # Role-based authorization policies
apps/api/routes/api.php                               # User management API routes
apps/api/tests/Feature/UserManagementTest.php         # Feature tests for user management
apps/api/tests/Unit/UserResourceTest.php              # Unit tests for Filament resource
```

### Role Hierarchy Implementation
Based on existing User model roles:
- **Company Admin**: Can invite and manage all roles (Admin, Manager, Operator)
- **Manager**: Can invite and manage Operator role only
- **Operator**: Cannot invite or manage other users

### Technical Constraints
Authentication Strategy: [Source: architecture/44-backend-architecture-laravel.md]
- Laravel Sanctum for API token protection
- Global stancl/tenancy middleware scoping for all requests
- Role-based access control using User model role field
- Session authentication for Filament admin panel access

### Security Enhancements Required
Based on Story 1.2 QA findings, this story must address:
- Use cryptographically secure token generation for invitations
- Implement comprehensive input validation for all user data
- Add rate limiting to invitation endpoints
- Ensure proper foreign key constraints and unique constraints
- Implement proper authorization policies for all user management actions

### Testing Standards
Testing framework and strategy: [Source: architecture/61-testing-strategy.md]
- **Unit Tests:** Pest for backend user management logic and Filament resources
- **Integration Tests:** Pest for service layer interactions and role-based access control
- **Feature Tests:** Full user management workflows including invitation and role hierarchy
- **Authorization Tests:** Comprehensive testing of role-based permissions

### Integration Requirements
This story builds upon and must integrate with:
- Existing invitation system from Story 1.2 (enhance, don't replace)
- Authentication system from Story 1.3 (maintain compatibility)
- Filament admin panel framework (extend existing configuration)
- Activity logging system (add new event types)

## Testing

### Testing Framework Requirements
[Source: architecture/61-testing-strategy.md]
- **Unit Tests:** Pest for the backend user management components
- **Integration Tests:** Pest for service layer interactions and role validation
- **Feature Tests:** Full user management workflows with proper tenant scoping

### Specific Testing Requirements for this Story
- **Role Hierarchy Testing:** Verify Managers cannot invite Admins
- **Permission Testing:** Ensure proper authorization for all user management actions
- **Tenant Isolation:** Verify users can only manage users within their own tenant
- **Invitation Testing:** Test invitation flow with different roles and duplicate prevention
- **Activity Logging:** Verify all user management actions are properly logged

### Code Quality Standards
[Source: architecture/62-coding-standards.md]
- All code must pass Pint linting checks for PHP
- Comprehensive test coverage required for all new functionality
- Follow existing patterns from Stories 1.2 and 1.3

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-13 | 1.0 | Initial story creation with comprehensive requirements for hierarchical user management | Bob (Scrum Master) |
| 2025-08-13 | 1.1 | Added project cleanup task to remove deprecated mobile directory | Bob (Scrum Master) |